@model ReportsViewModel
@{
    ViewData["Title"] = "Reports";
}

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Admin/Dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active">Reports</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="@Url.Action("ExportReports", "Admin")" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Export to Excel
            </a>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-danger mb-0">@Model.TotalDonors</h3>
                <small class="text-muted">Total Donors</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success mb-0">@Model.ActiveDonors</h3>
                <small class="text-muted">Active Donors</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info mb-0">@Model.TotalDonations</h3>
                <small class="text-muted">Total Donations</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary mb-0">@Model.CompletedDonations</h3>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning mb-0">@Model.TotalBloodRequests</h3>
                <small class="text-muted">Hospital Requests</small>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success mb-0">@Model.FulfilledRequests</h3>
                <small class="text-muted">Fulfilled</small>
            </div>
        </div>
    </div>
</div>

<!-- Blood Type Distribution -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-tint"></i> Blood Type Distribution & Availability</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Blood Type</th>
                                <th>Donors</th>
                                <th>Completed Donations</th>
                                <th>Total Collected (ml)</th>
                                <th>Fulfilled Requests (ml)</th>
                                <th>Available Now (ml)</th>
                                <th>Pending Hospital Requests</th>
                                <th>Requested Quantity (ml)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bt in Model.BloodTypeDistribution)
                            {
                                var availability = bt.AvailableQuantity == 0 ? "Out of Stock" : bt.AvailableQuantity >= bt.RequestedQuantity ? "Sufficient" : "Low Stock";
                                var badgeClass = bt.AvailableQuantity == 0 ? "bg-danger" : bt.AvailableQuantity >= bt.RequestedQuantity ? "bg-success" : "bg-warning text-dark";
                                
                                <tr>
                                    <td><span class="badge bg-danger fs-6">@bt.BloodType</span></td>
                                    <td>@bt.DonorCount</td>
                                    <td>@bt.CompletedDonations</td>
                                    <td><strong>@bt.TotalQuantity.ToString("N0")</strong></td>
                                    <td class="text-danger">-@bt.FulfilledQuantity.ToString("N0")</td>
                                    <td><strong class="text-success">@bt.AvailableQuantity.ToString("N0")</strong></td>
                                    <td>
                                        @if (bt.PendingRequests > 0)
                                        {
                                            <span class="badge bg-warning text-dark">@bt.PendingRequests</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td>@bt.RequestedQuantity.ToString("N0")</td>
                                    <td><span class="badge @badgeClass">@availability</span></td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <td><strong>TOTAL</strong></td>
                                <td><strong>@Model.BloodTypeDistribution.Sum(b => b.DonorCount)</strong></td>
                                <td><strong>@Model.BloodTypeDistribution.Sum(b => b.CompletedDonations)</strong></td>
                                <td><strong>@Model.BloodTypeDistribution.Sum(b => b.TotalQuantity).ToString("N0")</strong></td>
                                <td class="text-danger"><strong>-@Model.BloodTypeDistribution.Sum(b => b.FulfilledQuantity).ToString("N0")</strong></td>
                                <td><strong class="text-success">@Model.BloodTypeDistribution.Sum(b => b.AvailableQuantity).ToString("N0")</strong></td>
                                <td><strong>@Model.BloodTypeDistribution.Sum(b => b.PendingRequests)</strong></td>
                                <td><strong>@Model.BloodTypeDistribution.Sum(b => b.RequestedQuantity).ToString("N0")</strong></td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Donations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Monthly Donation Statistics (Last 12 Months)</h5>
            </div>
            <div class="card-body">
                @if (Model.MonthlyDonations.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Number of Donations</th>
                                    <th>Total Quantity (ml)</th>
                                    <th>Average per Donation (ml)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var month in Model.MonthlyDonations)
                                {
                                    var average = month.Count > 0 ? (month.TotalQuantity / month.Count) : 0;
                                    <tr>
                                        <td><strong>@month.Month</strong></td>
                                        <td>@month.Count</td>
                                        <td>@month.TotalQuantity.ToString("N0")</td>
                                        <td>@average.ToString("N0")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>@Model.MonthlyDonations.Sum(m => m.Count)</strong></td>
                                    <td><strong>@Model.MonthlyDonations.Sum(m => m.TotalQuantity).ToString("N0")</strong></td>
                                    <td><strong>@((Model.MonthlyDonations.Sum(m => m.Count) > 0 ? Model.MonthlyDonations.Sum(m => m.TotalQuantity) / Model.MonthlyDonations.Sum(m => m.Count) : 0).ToString("N0"))</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-center text-muted py-4">No donation data available yet.</p>
                }
            </div>
        </div>
    </div>
</div>
